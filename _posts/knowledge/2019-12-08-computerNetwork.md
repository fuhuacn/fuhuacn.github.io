---
layout: post
title: 计算机网络
categories: Knowledge
description: Linux
keywords: Linux
---
[参考来源](https://github.com/CyC2018/CS-Notes/blob/master/notes/计算机网络%20-%20目录.md)

目录

* TOC
{:toc}

# 一、概述

## 互联网

网络把主机连接起来，而互连网（internet）是把多种不同的网络连接起来，因此互连网是网络的网络。而互联网（Internet）是全球范围的互连网。

## ISP（Internet Service Provider）

互联网服务提供商 ISP 可以从互联网管理机构获得许多 IP 地址，同时拥有通信线路以及路由器等联网设备，个人或机构向 ISP 缴纳一定的费用就可以接入互联网。

目前的互联网是一种多层次 ISP 结构，ISP 根据覆盖面积的大小分为第一层 ISP、区域 ISP 和接入 ISP。互联网交换点 IXP（Internet Exchange Point）允许两个 ISP 直接相连而不用经过第三个 ISP。

## 主机间通信

+ 客户-服务器（C/S）：客户是服务的请求方，服务器是服务的提供方。
+ 对等（P2P）：不区分客户和服务器。

## 电路交换

电路交换用于电话通信系统，两个用户要通信之前需要建立一条专用的物理链路，并且在整个通信过程中始终占用该链路。由于通信的过程中不可能一直在使用传输线路，因此电路交换对线路的利用率很低，往往不到 10%。

通俗地说就是电信局在罗密欧与朱丽叶之间拉一根电话线，这根电话线只供罗密欧与朱丽叶通话用。

## 分组交换

每个分组都有首部和尾部，包含了源地址和目的地址等控制信息，在同一个传输线路上同时传输多个分组互相不会影响，因此在同一条传输线路上允许同时传输多个分组，也就是说分组交换不需要占用传输线路。

在一个邮局通信系统中，邮局收到一份邮件之后，先存储下来，然后把相同目的地的邮件一起转发到下一个目的地，这个过程就是存储转发过程，分组交换也使用了存储转发过程。

如果罗密欧想与朱丽叶（6.6.6.6）通信，则通信数据被切割成N个IP包，每个IP包都需要有地址（6.6.6.6）信息，因为网络是共享的，每个IP包进入网络时，都需要明确告诉网络，自己要去哪里，这点和电路交换有本质的区别，电路交换一旦接通，是不需要地址信息的。

## 时延

总时延 = 排队时延 + 处理时延 + 传输时延 + 传播时延

![时延](/images/posts/knowledge/computerNetwork/时延.jpeg)

### 排队时延

分组在路由器的输入队列和输出队列中排队等待的时间，取决于网络当前的通信量。

### 处理时延

主机或路由器收到分组时进行处理所需要的时间，例如分析首部、从分组中提取数据、进行差错检验或查找适当的路由等。

### 传输时延

主机或路由器传输数据帧所需要的时间。即：数据帧的长度(bits) / 传输速度(bits/s)

### 传播时延

电磁波在信道中传播所需要花费的时间，电磁波传播的速度接近光速。

## 计算机网络体系结构

![计算机体系结构](/images/posts/knowledge/computerNetwork/计算机体系结构.png)

首先我们说一个设备工作在几层的时候，其实指的是这个设备拥有这一层和这一层以下层的功能。

那电脑是一个七层设备，他就拥有七层功能 六层功能 五层功能 四层功能 三层功能 二层功能 和一层功能。

### 五层协议
  
五层模型只是为了方便介绍计算机网络原理而设计的，而在实际应用中还是TCP/IP四层模型。五层模型可以更方便的加深我们对问题的理解，例如：[二层交换机和三层交换机](https://zhuanlan.zhihu.com/p/64455461)。二层交换机工作在数据链路层，以太网交换机，根据 mac 地址转发。三层交换工作在网络层，根据 ip 地址（可以划分网段）转发。
+ 应用层 ：为特定应用程序提供数据传输服务，例如 HTTP、DNS 等协议。数据单位为报文。
+ 传输层 ：为进程提供通用数据传输服务。由于应用层协议很多，定义通用的传输层协议就可以支持不断增多的应用层协议。运输层包括两种协议：传输控制协议 TCP，提供面向连接、可靠的数据传输服务，数据单位为报文段；用户数据报协议 UDP，提供无连接、尽最大努力的数据传输服务，数据单位为用户数据报。TCP 主要提供完整性服务，UDP 主要提供及时性服务。
+ 网络层 ：为主机提供数据传输服务。而传输层协议是为主机中的进程提供数据传输服务。网络层把传输层传递下来的报文段或者用户数据报封装成分组。
+ 数据链路层 ：网络层针对的还是主机之间的数据传输服务，而主机之间可以有很多链路，链路层协议就是为同一链路的主机提供数据传输服务。数据链路层把网络层传下来的分组封装成帧。
+ 物理层 ：考虑的是怎样在传输媒体上传输数据比特流，而不是指具体的传输媒体。物理层的作用是尽可能屏蔽传输媒体和通信手段的差异，使数据链路层感觉不到这些差异。

### OSI（Open System Interconnection） 七层模型
  
将应用层又拆为了应用层、表示层和会话层。
+ 表示层：数据压缩、加密以及数据描述，这使得应用程序不必关心在各台主机中数据内部格式不同的问题。
+ 会话层 ：建立及管理会话。

五层协议没有表示层和会话层，而是将这些功能留给应用程序开发者处理。

### TCP/IP 四层模型
  
它只有四层，相当于五层协议中数据链路层和物理层合并为网络接口层。

TCP/IP 体系结构不严格遵循 OSI 分层概念，应用层可能会直接使用 IP 层或者网络接口层。

![四层协议](/images/posts/knowledge/computerNetwork/四层协议.png)

### 各层协议设备

+ 物理层： RJ45 、 CLOCK 、 IEEE802.3 （中继器，集线器，网关）
+ 数据链路： PPP 、 FR 、 HDLC 、 VLAN 、 MAC （网桥，交换机）
+ 网络层： IP 、 ICMP 、 ARP 、 RARP 、 OSPF 、 IPX 、 RIP 、 IGRP 、 （路由器）
+ 传输层： TCP 、 UDP 、 SPX - 会话层： NFS 、 SQL 、 NETBIOS 、 RPC
+ 表示层： JPEG 、 MPEG 、 ASII
+ 应用层： FTP 、 DNS 、 Telnet 、 SMTP 、 HTTP 、 WWW 、 NFS

### 数据在各层之间的传递过程

在向下的过程中，需要添加下层协议所需要的首部或者尾部，而在向上的过程中不断拆开首部和尾部。

路由器只有下面三层协议，因为路由器位于网络核心中，不需要为进程或者应用程序提供服务，因此也就不需要传输层和应用层。

# 二、物理层

## 通信方式

根据信息在传输线上的传送方向，分为以下三种通信方式：

+ 单工通信：单向传输
+ 半双工通信：双向交替传输
+ 全双工通信：双向同时传输

# 三、数据链路层

## 目的

链路层协议定义了在链路两端节点之间交互的分组格式，以及当发送和接收分组时这些节点采取的动作。

链路层协议交换的数据单元称为帧，帧封装了一个网络层的数据报。

链路层协议的例子如以太网、802.11 无线 LAN(也称为 WiFi)、PPP 协议。

一个数据报从源主机传输到目的主机，在路径的不同链路上可能有不同链路层协议。

例如在第一段链路上可能由以太网承载，在最后一段链路上可能由 PPP 承载，而在中间的链 路上由广域网的链路层协议承载。

链路层的基本服务都是将数据报通过单一通信链路从一个节点移动到相邻节点，所提供的服务细节随链路层协议而不同。

+ 成帧

  在经链路传送之前，每个网络层数据报用链路层帧封装起来。一个帧由一个数据字段和若干首部字段组成，其中网络层数据报就插在数据字段中。(一个帧也可能包括尾部字段)帧的结构由链路层协议规定。
+ 链路接入

  (介质访问控制)协议规定了帧在链路上传输的规则。
+ 可靠交付

  当链路层协议提供可靠交付服务时，它保证无差错地经链路层移动每个网络层数据报。但许多有线链路层协议例如以太网不提供可靠交付服务。
+ 流量控制

	链路每一端的节点都具有有限容量的帧缓存能力，链路层协议能够提供流量控制，以防止链路一端的发送节点淹没另一端的接收节点。
+ 差错检测

	链路层的差错检测通常更复杂，例如采用 CRC(循环冗余校验编码)，并且用硬件实现。

+ 差错纠正

	差错纠正和差错检测类似，区别在于接收方不仅能检测帧中是否引入了差错，而且能够判决帧中差错出现的位置。

+ 半双工和全双工通信。
  
  采用全双工传输时，链路两端的节点可以同时传输分组。采用半双工传输时，一个节点不能同时进行传输和接收。

## 基本问题

### 1. 封装成帧

将网络层传下来的分组添加首部和尾部，用于标记帧的开始和结束。

![封装成帧](/images/posts/knowledge/computerNetwork/封装成帧.png)

### 2. 透明传输（转义符）

透明表示一个实际存在的事物看起来好像不存在一样。

帧使用首部和尾部进行定界，如果帧的数据部分含有和首部尾部相同的内容，那么帧的开始和结束位置就会被错误的判定。需要在数据部分出现首部尾部相同的内容前面插入转义字符。如果数据部分出现转义字符，那么就在转义字符前面再加个转义字符。在接收端进行处理之后可以还原出原始数据。这个过程透明传输的内容是转义字符，用户察觉不到转义字符的存在。

### 3. 差错检测

目前数据链路层广泛使用了循环冗余检验（CRC）来检查比特差错。

## 信道分类

### 1. 广播信道

一对多通信，一个节点发送的数据能够被广播信道上所有的节点接收到。

所有的节点都在同一个广播信道上发送数据，因此需要有专门的控制方法进行协调，避免发生冲突（冲突也叫碰撞）。

主要有两种控制方法进行协调，一个是使用信道复用技术，一是使用 CSMA/CD 协议。

### 2. 点对点信道

一对一通信。

因为不会发生碰撞，因此也比较简单，使用 PPP 协议进行控制。

## 信道复用技术

### 1. 频分复用

### 2. 时分复用

时分复用的所有主机在不同的时间占用相同的频率带宽资源。

时分复用的所有主机在不同的时间占用相同的频率带宽资源。

使用频分复用和时分复用进行通信，在通信的过程中主机会一直占用一部分信道资源。但是由于计算机数据的突发性质，通信过程没必要一直占用信道资源而不让出给其它用户使用，因此这两种方式对信道的利用率都不高。

### 3. 统计时分复用

是对时分复用的一种改进，不固定每个用户在时分复用帧中的位置，只要有数据就集中起来组成统计时分复用帧然后发送。

### 4. 波分复用

光的频分复用。由于光的频率很高，因此习惯上用波长而不是频率来表示所使用的光载波。

### 5. 码分复用

为每个用户分配 m bit 的码片，并且所有的码片正交，当接收端使用码片对接收到的数据进行内积运算时，结果为 0 的是其它用户发送的数据，结果为 1 的是用户发送的比特 1，结果为 -1 的是用户发送的比特 0。码分复用需要发送的数据量为原先的 m 倍。

## MAC 地址

MAC 地址是链路层地址，长度为 6 字节（48 位），用于唯一标识网络适配器（网卡）。

一台主机拥有多少个网络适配器就有多少个 MAC 地址。例如笔记本电脑普遍存在无线网络适配器和有线网络适配器，因此就有两个 MAC 地址。

## 局域网

局域网是一种典型的广播信道，主要特点是网络为一个单位所拥有，且地理范围和站点数目均有限。

主要有以太网、令牌环网、FDDI 和 ATM 等局域网技术，目前以太网占领着有线局域网市场。

可以按照网络拓扑结构对局域网进行分类：

![网络拓扑](/images/posts/knowledge/computerNetwork/网络拓扑.jpeg)

## 以太网

以太网是一种星型拓扑结构局域网。

早期使用集线器进行连接，集线器是一种物理层设备， 作用于比特而不是帧，当一个比特到达接口时，集线器重新生成这个比特，并将其能量强度放大，从而扩大网络的传输距离，之后再将这个比特发送到其它所有接口。如果集线器同时收到两个不同接口的帧，那么就发生了碰撞。

目前以太网使用交换机替代了集线器（Hub 其实就是放大器，把之前的信号放大，但所有连接设备都会恭喜原来信号，交换机不同信号不会发送干扰），交换机是一种链路层设备，它不会发生碰撞，能根据 MAC 地址进行存储转发。

以太网帧格式：

类型 ：标记上层使用的协议；
数据 ：长度在 46-1500 之间，如果太小则需要填充；
FCS ：帧检验序列，使用的是 CRC 检验方法；

## 交换机

交换机（这里指二层交换机，最传统意义的交换机）具有自学习能力，学习的是交换表的内容，交换表中存储着 MAC 地址到接口的映射。

正是由于这种自学习能力，因此交换机是一种即插即用设备，不需要网络管理员手动配置交换表内容。

下图中，交换机有 4 个接口，主机 A 向主机 B 发送数据帧时，交换机把主机 A 到接口 1 的映射写入交换表中。为了发送数据帧到 B，先查交换表，此时没有主机 B 的表项，那么主机 A 就发送广播帧，主机 C 和主机 D 会丢弃该帧，主机 B 回应该帧向主机 A 发送数据包时，交换机查找交换表得到主机 A 映射的接口为 1，就发送数据帧到接口 1，同时交换机添加主机 B 到接口 2 的映射。

![交换机](/images/posts/knowledge/computerNetwork/交换机.png)

具体的工作流程如下：

+ 当交换机从某个端口收到一个数据包，它先读取包头中的源MAC地址，这样它就知道源MAC地址的机器是连在哪个端口上的；
+ 再去读取包头中的目的MAC地址，并在地址表中查找相应的端口；
+ 如表中有与这目的MAC地址对应的端口，把数据包直接复制到这端口上；
+ 如表中找不到相应的端口则把数据包广播到所有端口上，当目的机器对源机器回应时，交换机又可以学习一目的MAC地址与哪个端口对应，在下次传送数据时就不再需要对所有端口进行广播了。

不断的循环这个过程，对于全网的MAC地址信息都可以学习到，二层交换机就是这样建立和维护它自己的地址表。

**交换机与路由器：**

以宿舍内校园网为例：使用路由器的时候，路由器是一个 IP 地址，然后用 NAT 给每个人分了个局域网地址，所以一个人拨号就给路由器的 IP 地址拨了号，大家就都能直接走他的流量用了。而使用交换机 WAN 口的数据会分配给各自指定 MAC 地址的口，这样每台机器都会主动去 DHCP 那里请求根据自己的 MAC 地址分配 IP。大家的网流量也就不冲突了。

**与三层交换机区别：**

第三层交换工作在OSI七层网络模型中的第三层即网络层，是利用第三层协议中的IP包的包头信息来对后续数据业务流进行标记，具有同一标记的业务流的后续报文被交换到第二层数据链路层，从而打通源IP地址和目的IP地址之间的一条通路。这条通路经过第二层链路层。有了这条通路，三层交换机就没有必要每次将接收到的数据包进行拆包来判断路由，而是直接将数据包进行转发，将数据流进行交换。

比如A要给B发送数据，已知目的 IP，那么A就用子网掩码取得网络地址，判断目的 IP 是否与自己在同一网段。

使用 IP 的设备 A------------三层交换机----------------使用 IP 的设备 B

如果在同一网段，但不知道转发数据所需的 MAC 地址，A就发送一个 ARP（IP 转 MAC）请求，B 返回其 MAC 地址，A 用此 MAC 封装数据包并发送给交换机，交换机起用二层交换模块，查找 MAC 地址表，将数据包转发到相应的端口。

如果目的 IP 地址显示不是同一网段的，那么 A 要实现和 B 的通讯，在流缓存条目中没有对应 MAC 地址条目，就将第一个正常数据包发送向一个缺省网关，这个缺省网关一般在操作系统中已经设好，对应第三层路由模块，所以可见对于不是同一子网的数据，最先在 MAC 表中放的是缺省网关的 MAC 地址；然后就由三层路由模块接收到此数据包，查询路由表以确定到达 B 的路由，将构造一个新的帧头，其中以缺省网关的 MAC 地址为源 MAC 地址，以主机 B 的 MAC 地址为目的 MAC 地址。通过一定的识别触发机制，确立主机 A 与 B 的 MAC 地址及转发端口的对应关系，并记录进流缓存条目表，以后的 A 到 B 的数据，就直接交由二层交换模块完成。这就通常所说的一次路由多次转发。

二层交换机：基于MAC地址，三层交换机：具有VLAN功能 ，交换和路由，基于IP，就是网络。

## 虚拟局域网

虚拟局域网可以建立与物理位置无关的逻辑组，只有在同一个虚拟局域网中的成员才会收到链路层广播信息。

例如下图中 (A1, A2, A3, A4) 属于一个虚拟局域网，A1 发送的广播会被 A2、A3、A4 收到，而其它站点收不到。

使用 VLAN 干线连接来建立虚拟局域网，每台交换机上的一个特殊接口被设置为干线接口，以互连 VLAN 交换机。IEEE 定义了一种扩展的以太网帧格式 802.1Q，它在标准以太网帧上加进了 4 字节首部 VLAN 标签，用于表示该帧属于哪一个虚拟局域网。

![vlan](/images/posts/knowledge/computerNetwork/vlan.jpg)

# 四、网络层

## 概述

因为网络层是整个互联网的核心，因此应当让网络层尽可能简单。网络层向上只提供简单灵活的、无连接的、尽最大努力交互的数据报服务。

使用 IP 协议，可以把异构的物理网络连接起来，使得在网络层看起来好像是一个统一的网络。

![IP](/images/posts/knowledge/computerNetwork/ip层.png)

与 IP 协议配套使用的还有三个协议：

+ 地址解析协议 ARP（Address Resolution Protocol）
+ 网际控制报文协议 ICMP（Internet Control Message Protocol）
+ 网际组管理协议 IGMP（Internet Group Management Protocol）

## IP 数据包格式

![IP 格式](/images/posts/knowledge/computerNetwork/IP格式.jpeg)

+ 版本 : 有 4（IPv4）和 6（IPv6）两个值；
+ 首部长度 : 占 4 位，因此最大值为 15。值为 1 表示的是 1 个 32 位字的长度，也就是 4 字节。因为固定部分长度为 20 字节，因此该值最小为 5。如果可选字段的长度不是 4 字节的整数倍，就用尾部的填充部分来填充。
+ 区分服务 : 用来获得更好的服务，一般情况下不使用。
+ 总长度 : 包括首部长度和数据部分长度。
+ 生存时间 ：TTL，它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，当 TTL 为 0 时就丢弃数据报。可以使用 ping 理解，同时不同操作系统对应的 TTL 也不相同，可以用 ping 判断操作系统。
+ 协议 ：指出携带的数据应该上交给哪个协议进行处理，例如 ICMP、TCP、UDP 等。
+ 首部检验和 ：因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。
+ 标识 : 在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。
+ 片偏移 : 和标识符一起，用于发生分片的情况。片偏移的单位为 8 字节。

![片漂移](/images/posts/knowledge/computerNetwork/片漂移.png)

## IP 地址编址方式

IP 地址的编址方式经历了三个历史阶段：

+ 分类
+ 子网划分
+ 无分类

### 1. 分类

由两部分组成，网络号和主机号，其中不同分类具有不同的网络号长度，并且是固定的。

IP 地址 ::= {< 网络号 >, < 主机号 >}

![类别](/images/posts/knowledge/computerNetwork/ABCDE.png)

### 2. 子网划分

通过在主机号字段中拿一部分作为子网号，把两级 IP 地址划分为三级 IP 地址。

IP 地址 ::= {< 网络号 >, < 子网号 >, < 主机号 >}

要使用子网，必须配置子网掩码。一个 B 类地址的默认子网掩码为 255.255.0.0，如果 B 类地址的子网占两个比特，那么子网掩码为 11111111 11111111 11000000 00000000，也就是 255.255.192.0。

注意，外部网络看不到子网的存在。

**[VLAN 划分与子网划分联系与区别：](https://www.zhihu.com/question/51675361)**

子网划分是在网络层，它的作用是隔离不同网段之间的通信，比如 192.168.0.1/24 与 192.168.1.1/24 是不能直接通信的，注意这里是IP层的不通，数据链路层的报文是可达的，只不过在 IP 层被丢弃了。vlan 划分是在数据链路层，它的作用是隔离不同 vlan 之间的以太网帧的通信。而我们经常说的广播一般就是指由 arp、交换机转发时产生的以太网帧的广播，因此这种广播会被隔离在 vlan 中。由于在 IP 层已经可以有效隔离通信，因此我们经常说 vlan 划分主要用于广播隔离。为了便于管理和识别，子网划分和 vlan 划分经常做成一样的，比如公司内共有 30 个部门，您可以给每个部门划分一个子网和一个 vlan，也可以给每个子网划分更多 vlan，甚至可以给每个计算机划分一个 vlan。同vlan内划分不同子网，最常见的情况是：交换机不划分 vlan，则可认为所有主机都在 vlan1，此时即为同一 vlan 内划分多个网段。我认为子网划分不能取代 vlan 划分，因为隔离广播域是提升带宽利用率的重要手段；vlan 划分取代子网划分理论上是可以，但是我认为并不实用，因为子网划分通过 IP 和掩码很轻易就能看出，这种易识别性在日常管理中是很重要的。而 vlan 划分由交换机配置和主机的接入端口共同确定，难以观察识别，管理维护成本较高。总结：子网与 vlan 划分的都是为了隔离通信，只是 vlan 更底层，能够有效隔离我们通常意义上的广播。但是二者不存在必然的对应关系。

### 3. 无分类

无分类编址 CIDR 消除了传统 A 类、B 类和 C 类地址以及划分子网的概念，使用网络前缀和主机号来对 IP 地址进行编码，网络前缀的长度可以根据需要变化。

IP 地址 ::= {< 网络前缀号 >, < 主机号 >}

CIDR 的记法上采用在 IP 地址后面加上网络前缀长度的方法，例如 128.14.35.7/20 表示前 20 位为网络前缀。

CIDR 的地址掩码可以继续称为子网掩码，子网掩码首 1 长度为网络前缀的长度。

一个 CIDR 地址块中有很多地址，一个 CIDR 表示的网络就可以表示原来的很多个网络，并且在路由表中只需要一个路由就可以代替原来的多个路由，减少了路由表项的数量。把这种通过使用网络前缀来减少路由表项的方式称为路由聚合，也称为 构成超网 。

在路由表中的项目由“网络前缀”和“下一跳地址”组成，在查找时可能会得到不止一个匹配结果，应当采用最长前缀匹配来确定应该匹配哪一个。

CIDR表示方法：IP地址/网络ID的位数，比如192.168.23.35/21，其中用21位表示网络ID。